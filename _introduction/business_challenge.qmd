## The Business Challenge

```{r}
#| warning: false
#| echo: false
library(tidyverse)  # for plotting, includes ggplot
library(patchwork)  # for combining multiple plots into subfigures
library(scales)     # for formatting axis scales
library(ggokabeito) # color blind friendly color palette -- this course's default
library(ggthemes)   # some extra styling & themes to explore
```

```{r}
#| warning: false
#| eval: true
#| echo: false
#| cache: true

# Create data/ directory if it doesn't exist
if (!dir.exists("data")) {
  dir.create("data")
}
# Define URL and destination file path
url <- "https://github.com/unimelb-cmce-10002/fba-book/raw/refs/heads/main/data/melbourne_housing.csv"
destfile <- "data/melbourne_housing.csv"
# Download the file if it doesn't already exist
if (!file.exists(destfile)) {
  download.file(url, destfile, mode = "wb")
}
# Load the data
housing <- read_csv(destfile)
```

### The Topic: Understanding Melbourne’s Housing Market {.unnumbered}

Melbourne’s real estate market is one of the most dynamic in Australia. Property prices are influenced by several factors, including location, dwelling type, and proximity to the Central Business District (CBD). Buyers, sellers, and policymakers constantly analyze housing trends to make informed decisions. Understanding these trends is crucial in a $2 trillion+ housing market, where even small fluctuations in pricing expectations can have significant financial impacts.

A key question we will explore is: How do property prices vary by region, dwelling type, and location? By analyzing real estate data, we can identify patterns that help explain the drivers of Melbourne’s housing prices and their implications for different stakeholders in the market.

### The Data: The Melbourne Housing Market Dataset {.unnumbered}

We will use a dataset containing real estate sales data from Melbourne. The dataset provides insights into housing trends and includes key variables that influence property prices.

The dataset captures the property location within broader metropolitan regions (regionname), allowing us to compare trends across different areas. It also includes the type of dwelling, classified as House (h), Townhouse (t), or Apartment (u), enabling us to assess price differences based on housing type. The sale price (price) provides a measure of market value, while the distance to the CBD (distance) helps analyze the impact of proximity to the city center on property prices.

Similar datasets are widely used by real estate analysts, banks, and property investors to assess housing trends, predict future movements, and guide investment decisions. Through this tutorial, we’ll work with real-world data to uncover patterns and develop a deeper understanding of Melbourne’s property market. Let's dive in!

### Where we're headed {.unnumbered}

Just a few lines of R code transform numbers to data visualizations.

From this:

```{r}
#| echo: false 
housing %>%
    select(type, address, postcode, price, distance, regionname) %>%
    head(10)
```

to this:

```{r}
#| fig-width: 7
#| fig-height: 7
#| fig-align: "center"
#| echo: false

## FINAL Histogram
price_hist <-
    housing %>%
    ggplot(aes(x = price, fill = type)) +
  # Show proportions instead of raw counts (within each facet)
  geom_histogram(
    aes(y = after_stat(count) / 
             tapply(after_stat(count), after_stat(PANEL), sum)[after_stat(PANEL)]),
    bins = 50
  ) +
  # Log-scale the x-axis to handle price skew
  scale_x_continuous(
    trans = "log10",
    labels = scales::dollar
  ) +
  # Format y-axis as percentages
  scale_y_continuous(
    labels = scales::label_percent()
  ) +
  # Add labels and title
  labs(
    x = "Price", 
    y = "Share of Listings", 
    title = "Prices by Dwelling Type"
  ) +
  # Create separate plots for each dwelling type
  facet_wrap(~type) +
  # Rotate x-axis labels for readability
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  # Use colorblind-friendly fill palette
  scale_fill_okabe_ito() +
  # Center the title
  theme(
    plot.title = element_text(hjust = 0.5)
  )

price_dist <-
  housing %>%
  filter(type == "House") %>%
  ggplot(aes(x = distance, y = price)) +
  # Scatter plot with reduced alpha to handle overplotting
  geom_point(alpha = 0.05, color = palette_okabe_ito()[2]) +
  # Polynomial fit to capture curvature (not just a straight line)
  geom_smooth(
    method = "lm",
    formula = y ~ poly(x, 2),   # Allow one bend in the trend line
    se = FALSE,
    color = palette_okabe_ito()[6],
    linewidth = 1
  ) +
  # Format y-axis as dollars
  scale_y_continuous(labels = scales::dollar) +
  # Add labels and center the title
  labs(
    x = "Distance to CBD (km)",
    y = "Price",
    title = "House Price vs. Distance"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

# region update only houses
region_bar <- 
  housing %>%
  # 1. Filter to only include "House" listings
  filter(type == "House") %>%
  # 2. Create the plot
  ggplot(
    # 2a. Reorder the region names based on frequency
    aes(x = fct_infreq(regionname))
  ) +
  # 3. Plot bar heights as proportions, not raw counts
  geom_bar(
    aes(y = after_stat(count) / sum(after_stat(count))),
    fill = palette_okabe_ito()[2]
  ) +
  # 4. Add informative axis labels and a title
  labs(
    x = "Region", 
    y = "Frequency",  # Note: this is technically a proportion, not % format
    title = "Number of Listings by Region"
  ) +
  # 5. Tweak the theme for better readability and presentation
  theme(
    axis.text.x = element_text(angle = 25, hjust = 1),  # Rotate x labels
    plot.title = element_text(hjust = 0.5)              # Center the title
  )

# Bringing together 
price_hist /    (region_bar | price_dist) + 
    plot_layout(guides = "collect") & 
    theme(legend.position = "bottom")


```

## Loading the Data

### R packages for today {.unnumbered}

```{r}
#| eval: false
library(tidyverse)  # for plotting, includes ggplot
library(patchwork)  # for combining multiple plots into subfigures
library(scales)     # for formatting axis scales
library(ggokabeito) # color blind friendly color palette -- this course's default
library(ggthemes)   # some extra styling & themes to explore
```

### Loading the Data in R {.unnumbered}

```{r}
#| warning: false
#| eval: false
#| echo: true
#| label: load-housing-data
#| cache: true

housing <-
    read_csv("data/melbourne_housing.csv")
```